Imports System.Net
Imports System.Net.Sockets
Module Module1
    Dim udp As New UdpClient
    Dim ep As New IPEndPoint(IPAddress.Any, 8889)

    Dim authpacket As String = "1d3501435606e4cc22b9dc2a0000000000006f42876543215444553220444c4332207630333400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001217c8d0101e14f00ae14df687474703a2f2f7777772e746573746472697665756e6c696d69746564322e636f6d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
    Dim authpacket2 As String = "1d3503000001001a0a8a926723280100687474703a2f2f7777772e746573746472697665756e6c696d69746564322e636f6d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
    'Dim authpacket3 As String = "1d3503000001001a0a8a926723280100687474703a2f2f7777772e746573746472697665756e6c696d69746564322e636f6d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
    Dim authpacket3 As String = "1d3505000a8a9267232852000001001a00ea6703791589ac30750a5da61ef9f4131aecd60f20e3531e6f215e55134314a55b16cdf6e67f1942c00c6ba2669ade5c0e316f369f5724e775365ceb13ef3a3add0569e9e895d4254cd14fc1d83cabd1aaeceb1e73c62007eaad698970725b6440138dea78055fea82208a3094148d69c620c5b448f25e3aafb868f640ec56663b20418730e12291e57e43d85a07c17fb7b2efb2abff36c340442cf1289703ffd04b151403e3bda815f608c596d76d753e012f11025ea9a72063d0d249f17f938ed6a567941e7025633e5fc095451ba7ac489cb56ab68019d7a951ac51f8da40497b42986365c9b82dee1a764d21e35c53c1ae"

    Dim count1 As Integer = 0

    Sub Main()
        udp.Client.SetSocketOption(SocketOptionLevel.Socket, SocketOptionName.ReuseAddress, True)
        udp.Client.Bind(ep)
        Console.WriteLine("Listening for TDU2 server packets on " + ep.Address.ToString() + ":" + ep.Port.ToString())
        While (True)
            Try
                Dim bytes As Byte() = udp.Receive(ep)
                Dim packet As String = System.Text.Encoding.ASCII.GetString(bytes)
                Console.WriteLine("---------------------------------------------------")
                If bytes(0) = Val("&HFD") And bytes(1) = Val("&HC7") Then
                    If bytes(2) = Val("&H00") And bytes(3) = Val("&H02") Then
                        Console.WriteLine("auth packet 1: " + packet)
                        Dim bytessendback As Byte() = StringToByteArray(authpacket)
                        Console.WriteLine("sending back data: " + System.Text.Encoding.ASCII.GetString(bytessendback))
                        Dim sendbackep As New IPEndPoint(ep.Address, ep.Port)
                        udp.Connect(sendbackep)
                        udp.Send(bytessendback, bytessendback.Length)
                        Console.WriteLine("success!")
                    ElseIf bytes(2) = Val("&H02") And bytes(3) = Val("&H00") Then
                        Console.WriteLine("auth packet 2: " + packet)
                        Dim bytessendback As Byte() = StringToByteArray(authpacket2)
                        Console.WriteLine("sending back data: " + System.Text.Encoding.ASCII.GetString(bytessendback))
                        Dim sendbackep As New IPEndPoint(ep.Address, ep.Port)
                        udp.Connect(sendbackep)
                        udp.Send(bytessendback, bytessendback.Length)
                        Console.WriteLine("success!")
                    ElseIf bytes(2) = Val("&H04") Then
                        Console.WriteLine("auth packet 3: " + packet)
                        Dim bytessendback As Byte() = StringToByteArray(authpacket3)
                        Console.WriteLine("sending back data: " + System.Text.Encoding.ASCII.GetString(bytessendback))
                        Dim sendbackep As New IPEndPoint(ep.Address, ep.Port)
                        udp.Connect(sendbackep)
                        udp.Send(bytessendback, bytessendback.Length)
                        Console.WriteLine("success!")
                    End If
                Else
                    Console.WriteLine("unknown packet: " + packet)
                End If
                Console.WriteLine("---------------------------------------------------")
            Catch ex As Exception
                Console.WriteLine("ERROR" + vbNewLine + ex.Source + vbNewLine + ex.Message + vbNewLine + ex.StackTrace)
                Console.WriteLine("---------------------------------------------------")
            End Try
        End While
    End Sub

    Public Function StringToByteArray(s As String) As Byte()
        ' remove any spaces from, e.g. "A0 20 34 34"
        s = s.Replace(" "c, "")
        ' make sure we have an even number of digits
        If (s.Length And 1) = 1 Then
            Throw New FormatException("Odd string length when even string length is required.")
        End If

        ' calculate the length of the byte array and dim an array to that
        Dim nBytes = s.Length \ 2
        Dim a(nBytes - 1) As Byte

        ' pick out every two bytes and convert them from hex representation
        For i = 0 To nBytes - 1
            a(i) = Convert.ToByte(s.Substring(i * 2, 2), 16)
        Next

        Return a

    End Function

End Module
